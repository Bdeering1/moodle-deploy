#!/bin/bash

continue_prompt() {
    read -t 20 -p "Do you want to continue? (y/N) [default: y] " yn
    yn=${yn:-$default} # use default if no input

    case "$yn" in
        [Yy] ) echo "Continuing...";;
        [Nn] ) echo "Exiting..."; exit 1;;
    esac
}

HR=--------------------------------------------------------------------------------

# Set environment variables
export MDL_DIR=~/moodle \
       MDL_DATA=~/var/www/moodle_data \
       PG_USER=moodleuser \
       PG_PASS=m@0dlEr

# Set locale info (prevents verbose locale warnings)
echo "LC_ALL=en_US.UTF-8" | sudo tee -a /etc/environment
echo "en_US.UTF-8 UTF-8" | sudo tee -a /etc/locale.gen
echo "LANG=en_US.UTF-8" | sudo tee -a /etc/locale.conf
sudo locale-gen en_US.UTF-8

# Install Dependencies
echo -e "$HR\n Installing dependencies...$HR"
sudo apt update && sudo apt upgrade -y && sudo apt install -y vim apache2 postgresql git php8.2 php8.2-{curl,dom,gd,intl,mbstring,pgsql,xml,zip}
# double check these php modules: json, pcre, xmlrpc

echo $HR
continue_prompt

# Install Moodle
echo -e "$HR\n Cloning Moodle repository...\n$HR"
git clone --depth 1 -b MOODLE_500_STABLE git://git.moodle.org/moodle.git $MDL_DIR

printf $HR
continue_prompt

# Create database
echo -e "$HR\n Creating Postgres database...\n$HR"
sudo -u postgres psql -U postgres -c "CREATE USER $PG_USER WITH PASSWORD '$PG_PASS'" && sudo -u postgres psql -U postgres -c "CREATE DATABASE moodle WITH OWNER $PG_USER"

printf $HR
continue_prompt

# Create moodledata directory
echo -e "$HR\n Creating Moodle data directory...\n$HR"
mkdir $MDL_DATA && sudo chown -R www-data:www-data $MDL_DATA && sudo chmod 0755 $MDL_DATA

# Start Moodle install
echo -e "$HR\n Creating Moodle data directory...\n$HR"
sudo chown -R www-data:www-data $MDL_DIR
sudo -u www-data php -d max_input_vars=5000 $MDL_DIR/admin/cli/install.php --agree-license --lang=en --wwwroot=http://localhost --dataroot=$MDL_DATA --dbtype=pgsql --dbuser=$PG_USER --dbpass=$PG_PASS --dbport=5432 --fullname="Rexdale Alliance Church" --shortname="Safe Church" --adminpass=12345 --non-interactive
sudo chown -R root:www-data $MDL_DIR && sudo chmod -R 0755 $MDL_DIR $MDL_DATA

printf $HR
continue_prompt

# Apache Modules
echo -e "$HR\n Enabling Apache modules...\n$HR"
sudo a2enmod rewrite headers expires rewrite

# Apache PHP Config
echo -e "$HR\n Copying Apache configuration files...\n$HR"
mkdir /var/log/php && sudo chown -R www-data:www-data /var/log/php
sudo mkdir /etc/php/8.2/apache2/conf.d && sudo cp moodle.ini /etc/php/8.2/apache2/conf.d/moodle.ini

# Apache Virtual Host Config
sudo cp moodle.conf etc/apache2/sites-available/moodle.conf

# Enable Moodle site
echo -e "$HR\n Enabling site...\n$HR"
sudo a2ensite moodle.conf # enable moodle site
sudo a2dissite 000-default.conf # disable Apache welcome page
