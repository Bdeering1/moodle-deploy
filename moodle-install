#!/bin/bash

# display script usage information
usage() {
    echo "Usage: $0 [OPTIONS]"
    echo "Options:"
    echo "  --root-url           Set the root url for your site"
    echo "  --site-name          Set the full name of your site"
    echo "  --short-name         Set a short-form name for your site"
    echo "  --admin-user         Set the admin username for your site"
    echo "  --admin-pass         Set the admin password for your site"
    echo "  --db-user            Set postgreSQL database user"
    echo "  --db-pass            Set postgreSQL database password"
    echo "  -h, --help           Display this help message"
    exit 1
}

# Prompt user and store result in a provided environment variable
get_input() {
    local prompt=$1
    local env_var=$2
    local default="$2_DEF"

    if [ -n "${!env_var}" ]; then
        echo "$env_var: set using cli flag"
        return 0
    fi

    read -p "$prompt" user_input
    if [ -n "$user_input" ]; then
        printf -v "$env_var" "%s" "$user_input"
    else
        printf -v "$env_var" "%s" "${!default}"
        echo "Using default: ${!env_var}"
    fi
}

continue_prompt() {
    read -t 30 -p "Do you want to continue? (y/n) [default: y] " yn
    yn=${yn:-y}

    case "$yn" in
        [Yy] ) echo "Continuing...";;
        [Nn] ) echo "Exiting..."; exit 1;;
    esac
}

normalize_url() {
    local normalized
    normalized=$(echo "$1" | sed -E 's/^(http|https):\/\///')
    normalized=$(echo "$normalized" | sed -E 's/^www\.//')
    normalized=$(echo "$normalized" | sed -E 's/\/$//')
    echo "$normalized"
}

echo_clr() {
    echo -e "\e[38;5;$2m$1\e[0m"
}
echo_pink() { echo_clr "$1" 204; }
echo_blue() { echo_clr "$1" 69; }
echo_purple() { echo_clr "$1" 135; }
echo_orange() { echo_clr "$1" 209; }
echo_green() { echo_clr "$1" 48; }

# Set environment variables
DB_USER_DEF=moodleuser
DB_PASS_DEF=m@0dlEr
WEB_ROOT_DEF=moodle.local
ADMIN_USER_DEF=admin
ADMIN_PASS_DEF=pass
SITE_NAME_DEF="Moodle Site"
SHORT_NAME_DEF="Moodle"
IS_PROD_DEF="n"

SITE_ALIAS=""
MDL_DIR=~/moodle
MDL_DATA=/var/www/moodle_data
DB_BACKUP_DIR=/var/backups/postgresql
DB_BACKUP_SCRIPT=/usr/local/bin/db_backup
DB_RESTORE_SCRIPT=/usr/local/bin/db_restore
DB_BACKUP_LOG=/var/log/db_backup.log
DB_RESTORE_LOG=/var/log/db_restore.log
HR=--------------------------------------------------------------------------------

# Parse command-line arguments
while [[ "$#" -gt 0 ]]; do
    case "$1" in
        --root-url )
            WEB_ROOT="$2"
            shift
            ;;
        --site-alias)
            SITE_ALIAS="$2"
            shift
            ;;
        --site-name )
            SITE_NAME="$2"
            shift
            ;;
        --short-name)
            SHORT_NAME="$2"
            shift
            ;;
        --admin-user)
            ADMIN_USER="$2"
            shift
            ;;
        --admin-pass)
            ADMIN_PASS="$2"
            shift
            ;;
        --db-user )
            DB_USER="$2"
            shift
            ;;
        --db-pass)
            DB_PASS="$2"
            shift
            ;;
        -h|--help )
            usage
            ;;
        * )
            echo "Unknown option: $1"
            usage
            ;;
    esac
    shift
done

# Get important values from user
if [ ! -f $MDL_DIR/config.php ]; then
    while true; do
        get_input "Enter site url [default: $WEB_ROOT_DEF]: " WEB_ROOT
        if echo $WEB_ROOT | grep -Pq '^((http|https)://)?(www\.)?([a-zA-Z0-9-]+\.)+[a-zA-Z]{2,}(/?)$'; then
            WEB_ROOT=$(normalize_url $WEB_ROOT)
            break
        else
            echo "Error: '$WEB_ROOT' is not a valid root URL."
            WEB_ROOT=""
        fi
    done
    while true; do
        get_input "Please enter an alias url (if any) [default: none]: " SITE_ALIAS
        if [ -n $SITE_ALIAS ]; then
            break
        elif echo $SITE_ALIAS | grep -Pq '^((http|https)://)?(www\.)?([a-zA-Z0-9-]+\.)+[a-zA-Z]{2,}(/?)$'; then
            SITE_ALIAS=$(normalize_url $)
            break
        else
            echo "Error: '$SITE_ALIAS' is not a valid root URL."
            SITE_ALIAS=""
        fi
    done

    get_input "Enter full site name [default: $SITE_NAME_DEF]: " SITE_NAME
    get_input "Enter short site name (1-2 words) [default: $SHORT_NAME_DEF]: " SHORT_NAME
    get_input "Enter admin username [default: $ADMIN_USER_DEF]: " ADMIN_USER
    get_input "Enter admin password [default: $ADMIN_PASS_DEF]: " ADMIN_PASS
    get_input "Enter database username [default: $DB_USER_DEF]: " DB_USER
    get_input "Enter database password [default: $DB_PASS_DEF]: " DB_PASS
    get_input "Is this a production server? (must have a publically accessible domain) (y/n) [default: n]: " IS_PROD
fi

echo_pink "$HR\nInitiating moodle install...\n$HR"

# Set locale info (prevents verbose locale warnings)
if ! cat /etc/locale.gen | tail | grep -w en_CA; then
    echo "LC_ALL=en_CA.UTF-8" | sudo tee -a /etc/environment
    echo "en_CA.UTF-8 UTF-8" | sudo tee -a /etc/locale.gen
    echo "LANG=en_CA.UTF-8" | sudo tee -a /etc/locale.conf
    sudo locale-gen en_CA.UTF-8
else
    echo "Skipping setting locale..."
fi

# Install Dependencies
echo_pink "$HR\n Installing dependencies...\n$HR"
sudo apt update && sudo apt upgrade -y

if [ ! -f "/etc/apt/sources.list.d/pgdg.list" ]; then
    sudo apt install gpg curl ca-certificates -y
    curl -fsSL https://www.postgresql.org/media/keys/ACCC4CF8.asc | sudo gpg --dearmor -o /etc/apt/trusted.gpg.d/postgresql.gpg # get postgres gpg key
    sudo sh -c 'echo "deb http://apt.postgresql.org/pub/repos/apt $(lsb_release -cs)-pgdg main" > /etc/apt/sources.list.d/pgdg.list' # add PostgreSQL apt repository
    sudo apt update -y
fi

sudo apt install -y apache2 postgresql-17 cron git ufw fail2ban php8.2 php8.2-{curl,dom,gd,intl,mbstring,pgsql,xml,zip}

echo_green "$HR\nDone installing dependencies."
continue_prompt

# Clone Moodle repository
if [ ! -d "$MDL_DIR" ]; then
    echo_pink "$HR\n Cloning Moodle repository...\n$HR"
    git clone --depth 1 -b MOODLE_500_STABLE git://git.moodle.org/moodle.git $MDL_DIR
else
    echo "Moodle directory exists. Skipping..."
fi

# Create database
if ! sudo -u postgres psql -lqt | cut -d \| -f 1 | grep -qw moodle; then
    echo_pink "$HR\n Creating Postgres database and Moodle data directory...\n$HR"
    sudo -u postgres psql -U postgres -c "CREATE USER $DB_USER WITH PASSWORD '$DB_PASS';"
    sudo -u postgres psql -U postgres -c "CREATE DATABASE moodle WITH OWNER $DB_USER;"
else
    echo "Moodle database exists. Skipping..."
fi

# Regular database backups
if ! sudo -u postgres crontab -l 2>/dev/null | grep -q ".*$DB_BACKUP_SCRIPT.*"; then
    echo_pink "$HR\n Setting up regular database backups...\n$HR"
    sudo mkdir -p $DB_BACKUP_DIR
    sudo chown postgres:postgres $DB_BACKUP_DIR
    sudo chmod 700 $DB_BACKUP_DIR
    echo "Creating script at $DB_BACKUP_SCRIPT:"
    sudo tee "$DB_BACKUP_SCRIPT" << EOF
#!/bin/bash

RETENTION_DAYS=7
TIMESTAMP=\$(date +"%Y%m%d_%H%M%S")
BACKUP_FILE="$DB_BACKUP_DIR/moodle_\$TIMESTAMP.sql.gz"

echo "Starting PostgreSQL backup for database: moodle..."
if pg_dump --format=c --file="\$BACKUP_FILE" "moodle"; then
    echo "Backup successful: \$BACKUP_FILE"
    
    echo "Deleting backups older than \$RETENTION_DAYS days..."
    find "$DB_BACKUP_DIR" -type f -name "moodle_*.sql.gz" -mtime +"\$RETENTION_DAYS" -delete
    echo "Old backups cleaned up."
else
    echo "Backup FAILED for database: moodle"
    exit 1
fi
EOF
    sudo chmod +x $DB_BACKUP_SCRIPT
    sudo touch $DB_BACKUP_LOG && sudo chown postgres:postgres $DB_BACKUP_LOG && sudo chmod 640 $DB_BACKUP_LOG
    sudo -u postgres sh -c "echo '0 0 * * 0 $DB_BACKUP_SCRIPT > $DB_BACKUP_LOG 2>&1' | crontab -"
    echo -e "\nAdded line to postgres user crontab:"
    sudo -u postgres crontab -l
else
    echo "Database backup tasks exists. Skipping..."
fi

# Restore db from latest backup
sudo touch $DB_RESTORE_LOG && sudo chown postgres:postgres $DB_RESTORE_LOG && sudo chmod 640 $DB_BACKUP_LOG
echo "Creating script at $DB_RESTORE_SCRIPT:"
sudo tee "$DB_RESTORE_SCRIPT" << EOF
#!/bin/bash
set -o pipefail # ensure errors propagate through tee commands

# Find latest backup file
echo "Locating latest database backup..." | tee -a $DB_RESTORE_LOG
LATEST_BACKUP="$DB_BACKUP_DIR/\$(sudo -u postgres ls -t $DB_BACKUP_DIR 2>/dev/null | head -n 1)"
if [ -z \$LATEST_BACKUP]; then
    echo "Error: No backup files found in $DB_BACKUP_DIR. Aborting..." | tee -a $DB_RESTORE_LOG
    exit 1
fi
echo "Located database backup at: \$LATEST_BACKUP"

# Terminate active db connections
echo "Terminating active database connections..." | tee -a $DB_RESTORE_LOG
if ! sudo -u postgres psql postgres -c "SELECT pg_terminate_backend(pid) FROM pg_stat_activity WHERE datname = 'moodle';" 2>&1 | tee -a $DB_RESTORE_LOG; then
    echo "Error: Failed to terminate active connections. Aborting..." | tee -a $DB_RESTORE_LOG
    exit 1
fi
echo "Active connections terminated." | tee -a $DB_RESTORE_LOG

# Drop existing database
echo "Dropping the existing database..." | tee -a $DB_RESTORE_LOG
if ! sudo -u postgres psql postgres -c "DROP DATABASE moodle;" 2>&1 | tee -a $DB_RESTORE_LOG; then
    echo "Error: Failed to drop existing database. Aborting..." | tee -a $DB_RESTORE_LOG
    exit 1
fi
echo "Moodle database dropped successfully." | tee -a $DB_RESTORE_LOG

# Create new empty database
echo "Creating a new empty database..." | tee -a $DB_RESTORE_LOG
if ! sudo -u postgres psql postgres -c "CREATE DATABASE moodle WITH OWNER \"$DB_USER\";" 2>&1 | tee -a "$DB_RESTORE_LOG"; then
    echo "Error: Failed to create moodle database. Aborting..." | tee -a $DB_RESTORE_LOG
    exit 1
fi
echo "Empty database created successfully." | tee -a $DB_RESTORE_LOG

# Restore backup
echo "Restoring database from backup..." | tee -a $DB_RESTORE_LOG
if ! sudo -u postgres pg_restore -v -U postgres -d moodle "\$LATEST_BACKUP" 2>&1 | tee -a $DB_RESTORE_LOG; then
    echo "Error: Failed to restore database from backup. Aborting..." | tee -a $DB_RESTORE_LOG
    exit 1
fi
echo "Database restored successfully." | tee -a $DB_RESTORE_LOG

# Run analyze command for postgresql optimizer
echo "Running analyzer..." | tee -a $DB_RESTORE_LOG
sudo -u postgres psql -U postgres -d "moodle" -c "ANALYZE;" 2>&1 | tee -a $DB_RESTORE_LOG
EOF
sudo chmod +x $DB_RESTORE_SCRIPT

# Create moodledata directory
if [ ! -d "$MDL_DATA" ]; then
    sudo mkdir $MDL_DATA && sudo chown -R www-data:www-data $MDL_DATA && sudo chmod 0755 $MDL_DATA
else
    echo "Moodle data directory exists. Skipping..."
fi

# Start Moodle install
if [ ! -f $MDL_DIR/config.php ]; then
    echo_pink "$HR\n Running Moodle installer...\n$HR"
    sudo chown -R www-data:www-data $MDL_DIR
    sudo -u www-data php -d max_input_vars=5000 $MDL_DIR/admin/cli/install.php --agree-license --lang=en --wwwroot="https://$WEB_ROOT" --dataroot=$MDL_DATA --dbtype=pgsql --dbuser="$DB_USER" --dbpass="$DB_PASS" --dbport=5432 --fullname="$SITE_NAME" --shortname="$SHORT_NAME" --adminuser="$ADMIN_USER" --adminpass="$ADMIN_PASS" --non-interactive
    sudo chown -R root:www-data $MDL_DIR && sudo chmod -R 775 $MDL_DIR $MDL_DATA
else
    echo "Moodle configuration file exists. Skipping..."
fi

echo_green "$HR\nDone creating database and installing core components."
continue_prompt

# Apache Modules
echo_pink "$HR\n Enabling Apache modules...\n$HR"
sudo a2enmod rewrite headers expires rewrite ssl

# Apache PHP Config
APACHE_PHP_CONFIG=/etc/php/8.2/apache2/conf.d/moodle.ini
echo_pink "$HR\n Creating Apache configuration files...\n$HR"
sudo mkdir /var/log/php && sudo chown -R www-data:www-data /var/log/php
sudo mkdir /etc/php/8.2/apache2/conf.d
if [ ! -f $APACHE_PHP_CONFIG ]; then
echo "Creating php configuration file at $APACHE_PHP_CONFIG:"
sudo tee "/etc/php/8.2/apache2/conf.d/moodle.ini" << EOF
; Moodle-specific PHP settings
memory_limit = 512M
max_execution_time = 300
upload_max_filesize = 512M
post_max_size = 512M
max_input_vars = 5000

; Error Reporting
display_errors = Off
log_errors = On
error_log = /var/log/php/php_errors.log

; Session Management
session.save_handler = files
session.save_path = /var/lib/php/sessions
session.auto_start = Off

; File Uploads
file_uploads = On

; OPcache
opcache.enable = 1
opcache.memory_consumption = 256
opcache.max_accelerated_files = 4000
opcache.validate_timestamps = 0
EOF
else
    echo "Apache php configuration exists. Skipping..."
fi

# Apache Virtual Host Config
APACHE_SITE_CONFIG=/etc/apache2/sites-available/moodle.conf
if [ ! -f $APACHE_SITE_CONFIG ]; then
    echo "Creating Apache virtual host configuration file at $APACHE_SITE_CONFIG:"
    sudo tee "$APACHE_SITE_CONFIG" << EOF
<VirtualHost *:80 [::]:80>
    ServerAdmin webmaster@localhost
    ServerName $WEB_ROOT
    ServerAlias $SITE_ALIAS

    DocumentRoot $MDL_DIR

    <Directory $MDL_DIR>
        Options FollowSymLinks
        AllowOverride All
        Require all granted
    </Directory>

    <Directory $MDL_DATA>
        Require all denied
    </Directory>

    ErrorLog \${APACHE_LOG_DIR}/moodle_error.log
    CustomLog \${APACHE_LOG_DIR}/moodle_access.log combined

    Redirect permanent / https://$WEB_ROOT
</VirtualHost>

# Suppress Apache's AH00558 warning
ServerName localhost
EOF
else
    echo "Apache virtual host configuration exists. Skipping..."
fi

# Temporary Apache Site (needed for production SSL certificate)
echo_pink "$HR\n Enabling temporary site...\n$HR"
sudo a2dissite 000-default.conf # disable Apache welcome page
sudo a2ensite moodle.conf # enable moodle site
sudo systemctl reload apache2
sudo systemctl status apache2 --no-pager --lines=0

# SSL Certificate
SSL_CERT_DIR=/etc/ssl/local_certs

case "$IS_PROD" in
    [Yy] )
        echo_pink "$HR\nCreating production SSL certificate\n$HR"
        sudo apt install certbot python3-certbot-apache
        sudo certbot --apache
        sed -i "\#Redirect permanent / https://$WEB_ROOT#d" "/etc/apache2/sites-available/moodle-le-ssl.conf"
    ;;
    [Nn] )
        echo_pink "$HR\nCreating local development SSL certificate\n$HR"
        curl -sSL -o mkcert "https://dl.filippo.io/mkcert/latest?for=linux/amd64"
        sudo chmod +x mkcert && sudo mv mkcert /usr/local/bin/mkcert
        mkcert $WEB_ROOT

        sudo mkdir -p $SSL_CERT_DIR
        sudo cp $WEB_ROOT.pem $SSL_CERT_DIR/moodle_dev.crt
        sudo cp $WEB_ROOT-key.pem $SSL_CERT_DIR/moodle_dev.key
        sudo chmod 600 $SSL_CERT_DIR/moodle_dev.key

        sudo rm $WEB_ROOT.pem $WEB_ROOT-key.pem

        echo "Appending to Apache virtual host configuration file at $APACHE_SITE_CONFIG:"
        sudo tee -a "$APACHE_SITE_CONFIG" << EOF
<VirtualHost *:443 [::]:443>
    ServerAdmin webmaster@localhost
    ServerName $WEB_ROOT
    ServerAlias $WEB_ROOT

    DocumentRoot $MDL_DIR

    <Directory $MDL_DIR>
        Options FollowSymLinks
        AllowOverride All
        Require all granted
    </Directory>

    <Directory $MDL_DATA>
        Require all denied
    </Directory>

    ErrorLog \${APACHE_LOG_DIR}/moodle_error.log
    CustomLog \${APACHE_LOG_DIR}/moodle_access.log combined

    SSLEngine on
    SSLCertificateFile $SSL_CERT_DIR/moodle_dev.crt
    SSLCertificateKeyFile $SSL_CERT_DIR/moodle_dev.key

    SSLProtocol all -SSLv2 -SSLv3
    SSLCipherSuite HIGH:!aNULL:!MD5:!RC4
    SSLHonorCipherOrder on
    SSLCompression off
</VirtualHost>
EOF

        cat << EOF
mkcert certificate is located at: $(mkcert -CAROOT)

To use HTTPS locally, first install the mkcert cli on your machine.
Find instructions at: https://github.com/FiloSottile/mkcert

Then install the certificate locally:
scp [your_vps_username]@[your_vps_ip]:$(mkcert -CAROOT)/rootCA.pem ~/mkcert-CAROOT
CAROOT=~/mkcert-CAROOT mkcert -install

# Add local domain to list of known hosts
echo "[your_vps_ip] $WEB_ROOT" | /etc/hosts
EOF
        ;;
esac

# IPv6 Config
echo_pink "$HR\n Configuring IPv6...\n$HR"
IPV6_LINE=$(ip -6 addr | grep "inet6" | grep -v "scope host" | grep -v "scope link" | grep "global")
IPV6_ADDR=$(echo "$IPV6_LINE" | awk '{print $2}' | cut -d'/' -f1)
IPV6_PREFIX=$(echo "$IPV6_LINE" | awk '{print $2}' | cut -d'/' -f2)
IPV6_GATEWAY=$(ip -6 route | grep "default via" | awk '{print $3}')
IFACE=$(echo "$IPV6_LINE" | awk '{print $NF}')

echo "Creating IPv6 network configuration at /etc/network/interfaces.d/50-cloud-init-ipv6:"
sudo tee "/etc/network/interfaces.d/50-cloud-init-ipv6" << EOF
auto $IFACE
iface $IFACE inet6 static
mtu 1500
address $IPV6_ADDR
netmask $IPV6_PREFIX
post-up /sbin/ip -6 route add $IPV6_GATEWAY dev $IFACE
post-up /sbin/ip -6 route add default via $IPV6_GATEWAY dev $IFACE
pre-down /sbin/ip -6 route del default via $IPV6_GATEWAY dev $IFACE
pre-down /sbin/ip -6 route del $IPV6_GATEWAY dev $IFACE
EOF

# Enable Moodle site
echo_pink "$HR\n Enabling site...\n$HR"
sudo systemctl reload apache2
sudo systemctl status apache2 --no-pager --lines=0

echo_green "$HR\n Done with Apache configuration."
continue_prompt

# Set up cron service
if ! sudo -u www-data crontab -l 2>/dev/null | grep -q ".*$MDL_DIR/admin/cli/cron.php.*"; then
    echo_pink "$HR\n Setting up Moodle cron service...\n$HR"
    sudo -u www-data sh -c "echo '* * * * * /usr/bin/php $MDL_DIR/admin/cli/cron.php >/dev/null' | crontab -"
    echo "Added line to www-data user crontab:"
    sudo -u www-data crontab -l
else
    echo "Moodle cron service exists. Skipping..."
fi

# Set up swapfile
MAX_SWAPSIZE=6000000000
if [ ! -f "/swapfile" ]; then
    echo_pink "$HR\n Creating swapfile...\n$HR"
    total_mem=$(free -b | awk '/Mem:/ {print $2}')
    if [ $total_mem -lt $MAX_SWAPSIZE ]; then
        swapfile_size=$total_mem
    else
        swapfile_size=$MAX_SWAPSIZE
    fi
    sudo fallocate -l $swapfile_size /swapfile
    sudo chmod 600 /swapfile
    sudo mkswap /swapfile
    sudo swapon /swapfile
    sudo sh -c "echo '/swapfile none swap sw 0 0' >> /etc/fstab"
    sudo sh -c "echo 'vm.swappiness=15' >> /etc/sysctl.conf"
    free -h
else
    echo "Swapfile exists. Skipping..."
fi

# Setup Fail2Ban
JAIL_CONFIG="/etc/fail2ban/jail.local"
if [ ! -f "$JAIL_CONFIG" ]; then
    echo_pink "$HR\n Setting up fail2ban (Brute-force protection)...\n$HR"
    echo "Creating fail2ban configuration file at $JAIL_CONFIG:"
    sudo tee "$JAIL_CONFIG" << EOF
[DEFAULT]
ignoreip = 127.0.0.1/8 ::1 192.168.16.0/24 192.168.1.0/24 $(curl ifconfig.me)
bantime = 15m
findtime = 5m
maxretry = 5

[sshd]
enabled = true
backend = systemd

[apache-auth]
enabled = true

[apache-badbots]
enabled = true

[apache-noscript]
enabled = true

[apache-overflows]
enabled = true
EOF
    sudo systemctl restart fail2ban
    sudo systemctl status fail2ban --no-pager --lines=0
else
    echo "Fail2ban configuration exists. Skipping..."
fi

# Setup UFW
echo_pink "$HR\n Setting up firewall...\n$HR"
sudo ufw allow ssh
sudo ufw allow http
sudo ufw allow https
echo "Allowed connection over ssh, http, and https."
echo "Enabling firewall (may required confirmation)..."
echo "y" | sudo ufw enable
sudo ufw status verbose
